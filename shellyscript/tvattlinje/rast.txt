// ========================================
// Noreko - Tv√§ttlinje Rast-registrering
// ========================================
// Detta script √∂vervakar en ing√•ng p√• Shelly-pucken
// och registrerar n√§r arbetare tar rast (ing√•ng h√∂g = rast)

// Konfiguration
let CONFIG = {
  rastInputPin: 3,           // Vilken ing√•ng som anv√§nds f√∂r rast-signalen
  debounceTime: 500,         // Debounce i millisekunder (500ms = 0.5s)
  webhookUrl: "http://192.168.0.100/api/v1.php?type=rast&line=tvattlinje",
  kvsKeyStatus: "rastStatus" // Nyckel f√∂r att spara status i Shelly KVS
};

// Variabler
let lastRastState = false;
let lastChangeTime = 0;

// Ladda senaste status fr√•n KVS (f√∂r att √∂verleva omstart)
function loadLastStatus() {
  Shelly.call("KVS.Get", { key: CONFIG.kvsKeyStatus }, function (res) {
    if (res && res.value !== undefined) {
      lastRastState = res.value === "1";
      print("Laddade senaste rast-status fr√•n KVS: ", lastRastState);
    } else {
      print("Ingen tidigare status i KVS, startar fr√•n false");
    }
  });
}

// Spara status till KVS
function saveStatus(status) {
  let statusValue = status ? "1" : "0";
  Shelly.call("KVS.Set", { 
    key: CONFIG.kvsKeyStatus, 
    value: statusValue 
  }, function (res, error_code, error_message) {
    if (error_code === 0) {
      print("Status sparad i KVS: ", status);
    } else {
      print("Kunde inte spara status: ", error_message);
    }
  });
}

// Skicka webhook till backend
function sendWebhook(rastStatus) {
  let url = CONFIG.webhookUrl + "&rast=" + (rastStatus ? 1 : 0);

  Shelly.call("HTTP.GET", { url: url }, function (result, error_code, error_message) {
    if (error_code === 0) {
      print("‚úì Webhook skickad - Rast: ", rastStatus ? "P√Ö" : "AV");
      if (result && result.body) {
        print("  Svar fr√•n server: ", result.body);
      }
    } else {
      print("‚úó Webhook-fel: ", error_code, " - ", error_message);
    }
  });
}

// Hantera f√∂r√§ndring av rast-status
function handleRastChange(state) {
  let currentTime = Date.now();

  // Debounce - ignorera snabba √§ndringar
  if (currentTime - lastChangeTime < CONFIG.debounceTime) {
    print("‚è± Debounce - ignorerar √§ndring");
    return;
  }

  // Kolla om status faktiskt har √§ndrats
  if (state !== lastRastState) {
    print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    print("üîÑ RAST-STATUS √ÑNDRAD!");
    print("   Tidigare: ", lastRastState ? "P√Ö RAST" : "ARBETAR");
    print("   Ny:       ", state ? "P√Ö RAST" : "ARBETAR");
    print("   Tid:      ", new Date().toISOString());
    print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

    // Uppdatera variabler
    lastRastState = state;
    lastChangeTime = currentTime;

    // Spara till KVS
    saveStatus(state);

    // Skicka till backend
    sendWebhook(state);
  }
}

// Event-hanterare f√∂r ing√•ngs-f√∂r√§ndring
Shelly.addEventHandler(function (event) {
  // Lyssna endast p√• v√•r rast-ing√•ng
  if (event.component === "input:" + CONFIG.rastInputPin) {
    if (event.info && event.info.state !== undefined) {
      handleRastChange(event.info.state);
    }
  }
});

// Timer f√∂r att √∂vervaka status √§ven utan events (s√§kerhet)
// K√∂r var 30:e sekund
Timer.set(30000, true, function() {
  let status = Shelly.getComponentStatus("input:" + CONFIG.rastInputPin);
  if (status && status.state !== undefined) {
    // Kontrollera om status skiljer sig fr√•n vad vi tror
    if (status.state !== lastRastState) {
      print("‚ö†Ô∏è Status-avvikelse uppt√§ckt av timer!");
      handleRastChange(status.state);
    }
  }
});

// ========================================
// START
// ========================================
print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
print("‚ïë  NOREKO - TV√ÑTTLINJE RAST-√ñVERVAKARE  ‚ïë");
print("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó");
print("  Ing√•ng:  Pin ", CONFIG.rastInputPin);
print("  Backend: ", CONFIG.webhookUrl);
print("  Debounce:", CONFIG.debounceTime, "ms");
print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");

// Ladda senaste status
loadLastStatus();

// V√§nta 1 sekund, sen l√§s initial status
Timer.set(1000, false, function() {
  let status = Shelly.getComponentStatus("input:" + CONFIG.rastInputPin);
  if (status && status.state !== undefined) {
    print("üìä Initial status: ", status.state ? "P√Ö RAST" : "ARBETAR");
    
    // Om status skiljer sig fr√•n KVS, skicka uppdatering
    if (status.state !== lastRastState) {
      handleRastChange(status.state);
    }
  }
});

print("‚úÖ Script aktivt och √∂vervakar raster!");
