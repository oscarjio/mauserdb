// ========================================
// Noreko - Rebotling: Rast + Kommando (Skift)
// ========================================

let CONFIG = {
  // Rast
  rastInputPin: 3,  // IngÃ¥ng fÃ¶r rast (hÃ¶g = pÃ¥ rast)
  rastDebounceTime: 500, // ms
  rastWebhookUrl: "http://192.168.0.100/api/v1.php?type=rast&line=rebotling",
  kvsKeyRastStatus: "rastStatus",

  // Kommando (spara skift / Ã¤ndra lÃ¶pnummer via D4015 pÃ¥ PLC)
  commandInputPin: 0,   // IngÃ¥ng fÃ¶r PLC-kommando (t.ex. knapp / relÃ¤)
  commandDebounceTime: 50, // ms
  commandWebhookUrl: "http://192.168.0.100/api/v1.php?type=command&line=rebotling"
};

// =======================
// Rast-variabler/KVS
// =======================
let lastRastState = false;
let lastRastChangeTime = 0;

function loadRastStatus() {
  Shelly.call("KVS.Get", { key: CONFIG.kvsKeyRastStatus }, function (res) {
    if (res && res.value !== undefined) {
      lastRastState = res.value === "1";
      print("Laddade rast-status frÃ¥n KVS: ", lastRastState);
    } else {
      print("Ingen tidigare rast-status i KVS, startar frÃ¥n false");
    }
  });
}

function saveRastStatus(status) {
  let v = status ? "1" : "0";
  Shelly.call("KVS.Set", {
    key: CONFIG.kvsKeyRastStatus,
    value: v
  }, function (res, error_code, error_message) {
    if (error_code === 0) {
      print("Rast-status sparad i KVS: ", status);
    } else {
      print("Kunde inte spara rast-status: ", error_message);
    }
  });
}

function sendRastWebhook(rastStatus) {
  let url = CONFIG.rastWebhookUrl + "&rast=" + (rastStatus ? 1 : 0);

  Shelly.call("HTTP.GET", { url: url }, function (result, error_code, error_message) {
    if (error_code === 0) {
      print("âœ“ RAST-webhook skickad: ", rastStatus ? "PÃ… RAST" : "ARBETAR");
      if (result && result.body) {
        print("  Svar: ", result.body);
      }
    } else {
      print("âœ— RAST-webhook-fel: ", error_code, " - ", error_message);
    }
  });
}

function handleRastChange(state) {
  let now = Date.now();

  if (now - lastRastChangeTime < CONFIG.rastDebounceTime) {
    print("â± Rast debounce - ignorerar Ã¤ndring");
    return;
  }

  if (state !== lastRastState) {
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    print("ğŸ”„ RAST-STATUS Ã„NDRAD!");
    print("   Tidigare: ", lastRastState ? "PÃ… RAST" : "ARBETAR");
    print("   Ny:       ", state ? "PÃ… RAST" : "ARBETAR");
    print("   Tid:      ", new Date().toISOString());
    print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

    lastRastState = state;
    lastRastChangeTime = now;

    saveRastStatus(state);
    sendRastWebhook(state);
  }
}

// =======================
// Kommando-variabler
// =======================
let lastCommandState = false;
let lastCommandChangeTime = 0;

function sendCommandWebhook() {
  let url = CONFIG.commandWebhookUrl;

  Shelly.call("HTTP.GET", { url: url }, function (result, error_code, error_message) {
    if (error_code === 0) {
      print("âœ“ COMMAND-webhook skickad: ", url);
      if (result && result.body) {
        print("  Svar: ", result.body);
      }
    } else {
      print("âœ— COMMAND-webhook-fel: ", error_code, " - ", error_message);
    }
  });
}

function handleCommandInput(state) {
  let now = Date.now();

  // Puls pÃ¥ stigande flank
  if (state && !lastCommandState && (now - lastCommandChangeTime > CONFIG.commandDebounceTime)) {
    print("ğŸ”” Kommando-puls pÃ¥ ingÃ¥ng ", CONFIG.commandInputPin, " â€“ skickar type=command");
    sendCommandWebhook();
  }

  lastCommandState = state;
  lastCommandChangeTime = now;
}

// =======================
// Event handlers
// =======================
Shelly.addEventHandler(function (event) {
  if (!event || !event.component || !event.info) return;

  // Rast
  if (event.component === "input:" + CONFIG.rastInputPin &&
      event.info.state !== undefined) {
    handleRastChange(event.info.state);
  }

  // Kommando (spara skift / Ã¤ndra lÃ¶pnummer)
  if (event.component === "input:" + CONFIG.commandInputPin &&
      event.info.state !== undefined) {
    handleCommandInput(event.info.state);
  }
});

// Extra sÃ¤kerhet â€“ pollar rast-ingÃ¥ng var 30:e sekund
Timer.set(30000, true, function () {
  let status = Shelly.getComponentStatus("input:" + CONFIG.rastInputPin);
  if (status && status.state !== undefined && status.state !== lastRastState) {
    print("âš ï¸ Rast-status-avvikelse upptÃ¤ckt av timer!");
    handleRastChange(status.state);
  }
});

// =======================
// START
// =======================
print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
print("â•‘  NOREKO - REBOTLING RAST + KOMMANDO   â•‘");
print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
print("  Rast-ingÃ¥ng:     Pin ", CONFIG.rastInputPin);
print("  Command-ingÃ¥ng:  Pin ", CONFIG.commandInputPin);
print("  Rast backend:    ", CONFIG.rastWebhookUrl);
print("  Cmd backend:     ", CONFIG.commandWebhookUrl);
print("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

loadRastStatus();

// LÃ¤s initial rast-status efter 1 sekund
Timer.set(1000, false, function () {
  let status = Shelly.getComponentStatus("input:" + CONFIG.rastInputPin);
  if (status && status.state !== undefined) {
    print("ğŸ“Š Initial rast-status: ", status.state ? "PÃ… RAST" : "ARBETAR");
    if (status.state !== lastRastState) {
      handleRastChange(status.state);
    }
  }
});

print("âœ… Script aktivt: rast + kommando pÃ¥ samma Shelly-script");

