<div class="my-bonus-container" *ngIf="loggedIn">

  <!-- Header -->
  <div class="mb-4">
    <h2><i class="fas fa-star me-2"></i>Min Bonus</h2>
    <small class="text-muted">Se din prestanda och bonushistorik</small>
  </div>

  <!-- Operator ID input -->
  <div class="card setup-card mb-4" *ngIf="!savedOperatorId">
    <div class="card-body text-center py-4">
      <i class="fas fa-id-badge fa-3x text-info mb-3"></i>
      <h5>Ange ditt anställningsnummer</h5>
      <p class="text-muted">Ditt anställningsnummer sparas lokalt i webbläsaren så du slipper ange det varje gång.</p>
      <div class="d-flex justify-content-center gap-2" style="max-width: 300px; margin: 0 auto;">
        <input type="text" class="form-control" placeholder="T.ex. 12345" [(ngModel)]="operatorId"
               (keyup.enter)="saveAndLoad()">
        <button class="btn btn-info" (click)="saveAndLoad()" [disabled]="!operatorId.trim()">
          <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Operator header when set -->
  <div class="d-flex justify-content-between align-items-center mb-3" *ngIf="savedOperatorId">
    <div>
      <span class="badge bg-info me-2">Operatör {{ savedOperatorId }}</span>
      <span class="badge bg-success me-2" *ngIf="operatorIdFromAccount" title="Kopplat till ditt konto">
        <i class="fas fa-link me-1"></i>Kopplat konto
      </span>
      <button class="btn btn-sm btn-outline-secondary" (click)="clearOperator()" *ngIf="!operatorIdFromAccount">
        <i class="fas fa-times me-1"></i>Byt
      </button>
    </div>
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group btn-group-sm">
        <button class="btn" [class.btn-info]="selectedPeriod === 'today'" [class.btn-outline-secondary]="selectedPeriod !== 'today'" (click)="changePeriod('today')">Idag</button>
        <button class="btn" [class.btn-info]="selectedPeriod === 'week'" [class.btn-outline-secondary]="selectedPeriod !== 'week'" (click)="changePeriod('week')">Vecka</button>
        <button class="btn" [class.btn-info]="selectedPeriod === 'month'" [class.btn-outline-secondary]="selectedPeriod !== 'month'" (click)="changePeriod('month')">Månad</button>
        <button class="btn" [class.btn-info]="selectedPeriod === 'year'" [class.btn-outline-secondary]="selectedPeriod !== 'year'" (click)="changePeriod('year')">År</button>
      </div>
      <button class="btn btn-sm btn-outline-success" (click)="exportBonusCSV()" *ngIf="stats?.daily_breakdown?.length"
              title="Exportera bonushistorik som CSV" aria-label="Exportera CSV">
        <i class="fas fa-file-csv me-1"></i>CSV
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-4">
    <i class="fas fa-spinner fa-spin fa-lg text-info"></i>
  </div>

  <!-- Error -->
  <div class="alert alert-warning" *ngIf="error && !loading">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
  </div>

  <!-- Stats -->
  <div *ngIf="stats && !loading">

    <!-- KPI Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Snittbonus</div>
          <div class="kpi-value" [ngClass]="getBonusClass(stats.kpis?.bonus_avg || 0)">
            {{ stats.kpis?.bonus_avg || 0 | number:'1.1-1' }}
          </div>
          <div class="kpi-sub">{{ getBonusTier(stats.kpis?.bonus_avg || 0) }}</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Effektivitet</div>
          <div class="kpi-value text-info">{{ stats.kpis?.effektivitet || 0 | number:'1.1-1' }}%</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Produktivitet</div>
          <div class="kpi-value text-primary">{{ stats.kpis?.produktivitet || 0 | number:'1.1-1' }}</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Kvalitet</div>
          <div class="kpi-value text-success">{{ stats.kpis?.kvalitet || 0 | number:'1.1-1' }}%</div>
        </div>
      </div>
    </div>

    <!-- Summary row -->
    <div class="row g-3 mb-4">
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">Position</span>
          <span class="mini-value">{{ getPositionName(stats.position) }}</span>
        </div>
      </div>
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">Cykler</span>
          <span class="mini-value">{{ stats.summary?.total_cycles || 0 }}</span>
        </div>
      </div>
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">IBC OK</span>
          <span class="mini-value text-success">{{ stats.summary?.total_ibc_ok || 0 }}</span>
        </div>
      </div>
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">IBC Kasserade</span>
          <span class="mini-value text-danger">{{ stats.summary?.total_ibc_ej_ok || 0 }}</span>
        </div>
      </div>
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">Arbetstimmar</span>
          <span class="mini-value">{{ stats.summary?.total_hours || 0 | number:'1.1-1' }}</span>
        </div>
      </div>
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">Rasttid (h)</span>
          <span class="mini-value text-warning">{{ (stats.summary?.total_rast_hours || 0) | number:'1.1-1' }}</span>
        </div>
      </div>
      <div class="col-md-2 col-4">
        <div class="mini-stat">
          <span class="mini-label">Max Bonus</span>
          <span class="mini-value text-warning">{{ stats.kpis?.bonus_max || 0 | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Charts row -->
    <div class="row g-3 mb-4">
      <div class="col-md-5">
        <div class="card chart-card">
          <div class="card-header"><h6 class="mb-0">KPI-profil</h6></div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="myKpiChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-7">
        <div class="card chart-card">
          <div class="card-header"><h6 class="mb-0">Bonushistorik</h6></div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="myHistoryChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bonus Projection -->
    <div class="card chart-card mb-3" *ngIf="getProjectedBonus() as proj">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            <i class="fas fa-chart-line fa-2x" [class.text-success]="getTrendDirection() === 'up'"
               [class.text-danger]="getTrendDirection() === 'down'"
               [class.text-muted]="getTrendDirection() === 'flat'"></i>
            <div>
              <div class="text-muted" style="font-size: 0.8rem;">Prognos baserad på senaste 7 dagarna</div>
              <div class="d-flex align-items-baseline gap-2">
                <strong [ngClass]="getBonusClass(proj.weekly)" style="font-size: 1.3rem;">{{ proj.weekly | number:'1.1-1' }}</strong>
                <span class="text-muted">förväntad snittbonus</span>
              </div>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <i class="fas" [class.fa-arrow-up]="getTrendDirection() === 'up'"
               [class.fa-arrow-down]="getTrendDirection() === 'down'"
               [class.fa-minus]="getTrendDirection() === 'flat'"
               [class.text-success]="getTrendDirection() === 'up'"
               [class.text-danger]="getTrendDirection() === 'down'"
               [class.text-muted]="getTrendDirection() === 'flat'"></i>
            <span class="text-muted" style="font-size: 0.85rem;">
              {{ getTrendDirection() === 'up' ? 'Stigande trend' : getTrendDirection() === 'down' ? 'Sjunkande trend' : 'Stabil trend' }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Daily breakdown table -->
    <div class="card chart-card" *ngIf="stats.daily_breakdown?.length > 0">
      <div class="card-header"><h6 class="mb-0"><i class="fas fa-table me-2"></i>Daglig uppdelning</h6></div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-sm table-hover">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Cykler</th>
                <th>IBC OK</th>
                <th>IBC Ej OK</th>
                <th>Eff.</th>
                <th>Prod.</th>
                <th>Kvalitet</th>
                <th>Bonus</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let day of stats.daily_breakdown">
                <td>{{ day.date }}</td>
                <td>{{ day.cycles }}</td>
                <td class="text-success">{{ day.ibc_ok }}</td>
                <td class="text-danger">{{ day.ibc_ej_ok }}</td>
                <td>{{ day.effektivitet | number:'1.1-1' }}%</td>
                <td>{{ day.produktivitet | number:'1.1-1' }}</td>
                <td>{{ day.kvalitet | number:'1.1-1' }}%</td>
                <td [ngClass]="getBonusClass(day.bonus_poang)"><strong>{{ day.bonus_poang | number:'1.1-1' }}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Nästa nivå -->
    <div class="card chart-card mt-3" *ngIf="stats?.kpis">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-arrow-up me-2"></i>Nästa bonusnivå</h6>
      </div>
      <div class="card-body">
        <div class="next-tier-info">
          <div class="current-tier">
            <span class="text-muted">Din nivå:</span>
            <strong [ngClass]="getBonusClass(stats.kpis.bonus_avg)">{{ getBonusTier(stats.kpis.bonus_avg) }}</strong>
          </div>
          <div class="next-tier" *ngIf="getNextTierInfo(stats.kpis.bonus_avg) as next">
            <span class="text-muted">Nästa nivå:</span>
            <strong class="text-info">{{ next.name }}</strong>
            <span class="text-muted ms-2">Behöver {{ next.pointsNeeded | number:'1.0-0' }} poäng till</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Hur bonus beräknas -->
    <div class="card chart-card mt-3">
      <div class="card-header" style="cursor: pointer;" (click)="showFormula = !showFormula">
        <h6 class="mb-0">
          <i class="fas fa-info-circle me-2"></i>Hur beräknas bonusen?
          <i class="fas fa-chevron-down float-end" [class.fa-chevron-up]="showFormula"></i>
        </h6>
      </div>
      <div class="card-body" *ngIf="showFormula">
        <div class="formula-section">
          <h6>Tre KPI:er</h6>
          <ul>
            <li><strong>Effektivitet</strong> = Godkända IBC / Totala IBC</li>
            <li><strong>Produktivitet</strong> = IBC per timme jämfört med mål</li>
            <li><strong>Kvalitet</strong> = (Godkända IBC - defekta burar) / Godkända IBC</li>
          </ul>

          <h6>Viktning (beror på produkt)</h6>
          <div class="table-responsive">
            <table class="table table-dark table-sm">
              <thead><tr><th>Produkt</th><th>Effektivitet</th><th>Produktivitet</th><th>Kvalitet</th><th>Mål (IBC/h)</th></tr></thead>
              <tbody>
                <tr><td>FoodGrade</td><td>30%</td><td>30%</td><td>40%</td><td>12</td></tr>
                <tr><td>NonUN</td><td>35%</td><td>45%</td><td>20%</td><td>20</td></tr>
                <tr><td>Tvättade</td><td>40%</td><td>35%</td><td>25%</td><td>15</td></tr>
              </tbody>
            </table>
          </div>

          <h6>Tier-multiplikatorer</h6>
          <div class="table-responsive">
            <table class="table table-dark table-sm">
              <thead><tr><th>Nivå</th><th>Poäng</th><th>Multiplikator</th></tr></thead>
              <tbody>
                <tr class="text-success"><td>Outstanding</td><td>95+</td><td>x2.0</td></tr>
                <tr class="text-info"><td>Excellent</td><td>90-94</td><td>x1.5</td></tr>
                <tr><td>God prestanda</td><td>80-89</td><td>x1.25</td></tr>
                <tr><td>Basbonus</td><td>70-79</td><td>x1.0</td></tr>
                <tr class="text-danger"><td>Under förväntan</td><td>&lt;70</td><td>x0.75</td></tr>
              </tbody>
            </table>
          </div>

          <p class="text-muted mb-0"><small>Slutbonus = min(BasBonus × TierMultiplikator, 200)</small></p>
        </div>
      </div>
    </div>

  </div>

</div>

<!-- Not logged in -->
<div *ngIf="!loggedIn" class="text-center py-5">
  <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
  <h4>Logga in</h4>
  <p class="text-muted">Du behöver vara inloggad för att se denna sida.</p>
</div>
