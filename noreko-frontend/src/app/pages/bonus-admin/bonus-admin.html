<div class="bonus-admin-container" *ngIf="loggedIn && isAdmin">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="fas fa-cogs me-2"></i>Bonus Administration</h2>
      <small class="text-muted">Konfigurera viktningar, mål och godkänn bonusar</small>
    </div>
  </div>

  <!-- Toast messages -->
  <div class="alert alert-success alert-dismissible fade show" *ngIf="successMessage">
    <i class="fas fa-check-circle me-2"></i>{{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''"></button>
  </div>
  <div class="alert alert-danger alert-dismissible fade show" *ngIf="errorMessage">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-pills mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'overview'" (click)="setTab('overview')">
        <i class="fas fa-chart-bar me-1"></i>Översikt
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'weights'" (click)="setTab('weights')">
        <i class="fas fa-balance-scale me-1"></i>Viktningar
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'targets'" (click)="setTab('targets')">
        <i class="fas fa-bullseye me-1"></i>Produktivitetsmål
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'periods'" (click)="setTab('periods')">
        <i class="fas fa-calendar-check me-1"></i>Perioder
      </a>
    </li>
  </ul>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-3">
    <i class="fas fa-spinner fa-spin fa-lg text-info"></i>
  </div>

  <!-- ========== ÖVERSIKT ========== -->
  <div *ngIf="activeTab === 'overview'">
    <div class="row g-3 mb-4" *ngIf="systemStats">
      <div class="col-md-3 col-6">
        <div class="stat-card">
          <div class="stat-label">Cykler (30 dagar)</div>
          <div class="stat-value">{{ systemStats.total_cycles }}</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="stat-card">
          <div class="stat-label">Unika operatörer</div>
          <div class="stat-value">{{ systemStats.unique_operators }}</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="stat-card">
          <div class="stat-label">Snittbonus</div>
          <div class="stat-value" [ngClass]="getBonusClass(systemStats.avg_bonus)">
            {{ systemStats.avg_bonus }}
            <i class="fas fa-sm" [ngClass]="getTrendIcon(systemStats.trend)"></i>
          </div>
          <div class="stat-sub">{{ systemStats.trend > 0 ? '+' : '' }}{{ systemStats.trend }}% trend</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="stat-card">
          <div class="stat-label">God prestanda (&ge;80)</div>
          <div class="stat-value text-success">{{ systemStats.high_performers_pct }}%</div>
        </div>
      </div>
    </div>

    <div class="row g-3" *ngIf="systemStats">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h6>Max Bonus</h6>
            <div class="display-6 text-success">{{ systemStats.max_bonus }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h6>Min Bonus</h6>
            <div class="display-6 text-danger">{{ systemStats.min_bonus }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <h6>Snittbonus</h6>
            <div class="display-6" [ngClass]="getBonusClass(systemStats.avg_bonus)">{{ systemStats.avg_bonus }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tier info -->
    <div class="card mt-4" *ngIf="config?.tier_multipliers">
      <div class="card-header"><h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>Tier-multiplikatorer</h6></div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-sm">
            <thead>
              <tr><th>Tier</th><th>Tröskel</th><th>Multiplikator</th></tr>
            </thead>
            <tbody>
              <tr *ngFor="let tier of config.tier_multipliers">
                <td><strong>{{ tier.name }}</strong></td>
                <td>&ge; {{ tier.threshold }} poäng</td>
                <td>x{{ tier.multiplier }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== VIKTNINGAR ========== -->
  <div *ngIf="activeTab === 'weights'">
    <div class="row g-4">
      <div class="col-md-4" *ngFor="let produktId of [1, 4, 5]">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">{{ getProductName(produktId) }}</h6>
            <button class="btn btn-sm btn-outline-info" *ngIf="!editingWeights[produktId]" (click)="startEditWeights(produktId)"
                    aria-label="Redigera viktningar" title="Redigera">
              <i class="fas fa-edit"></i>
            </button>
          </div>
          <div class="card-body">
            <!-- View mode -->
            <div *ngIf="!editingWeights[produktId]">
              <div class="weight-row">
                <span>Effektivitet</span>
                <span class="weight-value">{{ ((weightsForm[produktId]?.eff || 0) * 100) }}%</span>
              </div>
              <div class="progress mb-3" style="height: 6px;">
                <div class="progress-bar bg-info" [style.width.%]="(weightsForm[produktId]?.eff || 0) * 100"></div>
              </div>
              <div class="weight-row">
                <span>Produktivitet</span>
                <span class="weight-value">{{ ((weightsForm[produktId]?.prod || 0) * 100) }}%</span>
              </div>
              <div class="progress mb-3" style="height: 6px;">
                <div class="progress-bar bg-primary" [style.width.%]="(weightsForm[produktId]?.prod || 0) * 100"></div>
              </div>
              <div class="weight-row">
                <span>Kvalitet</span>
                <span class="weight-value">{{ ((weightsForm[produktId]?.qual || 0) * 100) }}%</span>
              </div>
              <div class="progress" style="height: 6px;">
                <div class="progress-bar bg-success" [style.width.%]="(weightsForm[produktId]?.qual || 0) * 100"></div>
              </div>
            </div>

            <!-- Edit mode -->
            <div *ngIf="editingWeights[produktId]">
              <div class="mb-3">
                <label class="form-label">Effektivitet</label>
                <input type="number" class="form-control form-control-sm" step="0.05" min="0" max="1"
                       [(ngModel)]="weightsForm[produktId].eff">
              </div>
              <div class="mb-3">
                <label class="form-label">Produktivitet</label>
                <input type="number" class="form-control form-control-sm" step="0.05" min="0" max="1"
                       [(ngModel)]="weightsForm[produktId].prod">
              </div>
              <div class="mb-3">
                <label class="form-label">Kvalitet</label>
                <input type="number" class="form-control form-control-sm" step="0.05" min="0" max="1"
                       [(ngModel)]="weightsForm[produktId].qual">
              </div>
              <div class="mb-3">
                <small [class]="getWeightsSum(produktId) === 1 ? 'text-success' : 'text-danger'">
                  Summa: {{ getWeightsSum(produktId) }} (måste vara 1.0)
                </small>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-success" (click)="saveWeights(produktId)" [disabled]="getWeightsSum(produktId) !== 1">
                  <i class="fas fa-save me-1"></i>Spara
                </button>
                <button class="btn btn-sm btn-outline-secondary" (click)="cancelEditWeights(produktId)">Avbryt</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== PRODUKTIVITETSMÅL ========== -->
  <div *ngIf="activeTab === 'targets'">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-bullseye me-2"></i>Produktivitetsmål (IBC/timme)</h6>
        <button class="btn btn-sm btn-outline-info" *ngIf="!editingTargets" (click)="startEditTargets()">
          <i class="fas fa-edit me-1"></i>Redigera
        </button>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-4">
            <div class="target-card">
              <h6>FoodGrade</h6>
              <div *ngIf="!editingTargets" class="target-value">{{ targetsForm.foodgrade }} <small>IBC/h</small></div>
              <input *ngIf="editingTargets" type="number" class="form-control" step="0.5" min="1" max="100"
                     [(ngModel)]="targetsForm.foodgrade">
              <small class="text-muted">Högre kvalitetskrav, lägre volym</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="target-card">
              <h6>NonUN</h6>
              <div *ngIf="!editingTargets" class="target-value">{{ targetsForm.nonun }} <small>IBC/h</small></div>
              <input *ngIf="editingTargets" type="number" class="form-control" step="0.5" min="1" max="100"
                     [(ngModel)]="targetsForm.nonun">
              <small class="text-muted">Volymproduktion</small>
            </div>
          </div>
          <div class="col-md-4">
            <div class="target-card">
              <h6>Tvättade IBC</h6>
              <div *ngIf="!editingTargets" class="target-value">{{ targetsForm.tvattade }} <small>IBC/h</small></div>
              <input *ngIf="editingTargets" type="number" class="form-control" step="0.5" min="1" max="100"
                     [(ngModel)]="targetsForm.tvattade">
              <small class="text-muted">Mellannivå</small>
            </div>
          </div>
        </div>
        <div class="mt-3 d-flex gap-2" *ngIf="editingTargets">
          <button class="btn btn-success" (click)="saveTargets()">
            <i class="fas fa-save me-1"></i>Spara mål
          </button>
          <button class="btn btn-outline-secondary" (click)="cancelEditTargets()">Avbryt</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== PERIODER ========== -->
  <div *ngIf="activeTab === 'periods'">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Bonusperioder (senaste 6 månader)</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-sm table-hover">
            <thead>
              <tr>
                <th>Period</th>
                <th>Cykler</th>
                <th>Operatörer</th>
                <th>Snittbonus</th>
                <th>IBC OK</th>
                <th>Success Rate</th>
                <th>Åtgärder</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of periods">
                <td><strong>{{ p.period }}</strong></td>
                <td>{{ p.total_cycles }}</td>
                <td>{{ p.unique_operators }}</td>
                <td [ngClass]="getBonusClass(p.avg_bonus)">{{ p.avg_bonus }}</td>
                <td>{{ p.total_ibc_ok }}</td>
                <td>
                  <div class="progress" style="height: 18px; min-width: 80px;">
                    <div class="progress-bar" [class.bg-success]="p.success_rate >= 70"
                         [class.bg-warning]="p.success_rate >= 50 && p.success_rate < 70"
                         [class.bg-danger]="p.success_rate < 50"
                         [style.width.%]="p.success_rate">
                      {{ p.success_rate }}%
                    </div>
                  </div>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success" (click)="approvePeriod(p.period)" title="Godkänn bonus"
                            aria-label="Godkänn bonusperiod">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-info" (click)="exportPeriod(p.period)" title="Exportera CSV"
                            aria-label="Exportera CSV-rapport">
                      <i class="fas fa-download"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <p class="text-muted text-center" *ngIf="periods.length === 0">Inga bonusperioder hittades.</p>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Not admin -->
<div *ngIf="loggedIn && !isAdmin" class="text-center py-5">
  <i class="fas fa-lock fa-3x text-muted mb-3"></i>
  <h4>Åtkomst nekad</h4>
  <p class="text-muted">Denna sida kräver admin-behörighet.</p>
</div>

<div *ngIf="!loggedIn" class="text-center py-5">
  <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
  <h4>Logga in</h4>
  <p class="text-muted">Du behöver vara inloggad för att se denna sida.</p>
</div>
