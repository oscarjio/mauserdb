<div class="bonus-dashboard-container" *ngIf="loggedIn && isAdmin">

  <!-- Header -->
  <div class="dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <h2 class="mb-0"><i class="fas fa-trophy me-2"></i>Bonus Dashboard - Rebotling</h2>
        <small class="text-muted">Realtidsöversikt av operatörsbonus</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm period-select" [(ngModel)]="selectedPeriod" (change)="onPeriodChange()">
          <option value="today">Idag</option>
          <option value="week">Senaste 7 dagar</option>
          <option value="month">Senaste 30 dagar</option>
          <option value="year">Senaste året</option>
        </select>
        <button class="btn btn-sm btn-outline-info" (click)="loadTeamStats()">
          <i class="fas fa-users me-1"></i>{{ showTeamView ? 'Dölj skift' : 'Visa skift' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-4">
    <i class="fas fa-spinner fa-spin fa-2x text-info"></i>
    <p class="text-muted mt-2">Laddar bonusdata...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="alert alert-danger alert-dismissible fade show">
    {{ error }}
    <button type="button" class="btn-close" (click)="error = ''"></button>
  </div>

  <!-- Daglig sammanfattning -->
  <div class="row g-3 mb-4" *ngIf="summary">
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Cykler idag</div>
        <div class="kpi-value">{{ summary.total_cycles }}</div>
        <div class="kpi-sub">{{ summary.shifts_today }} skift</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">IBC Godkända</div>
        <div class="kpi-value text-success">{{ summary.total_ibc_ok }}</div>
        <div class="kpi-sub">{{ summary.total_ibc_ej_ok }} kasserade</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Snittbonus</div>
        <div class="kpi-value" [ngClass]="getBonusClass(summary.avg_bonus)">{{ summary.avg_bonus }}</div>
        <div class="kpi-sub">poäng</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="kpi-card">
        <div class="kpi-label">Max Bonus</div>
        <div class="kpi-value" [ngClass]="getBonusClass(summary.max_bonus)">{{ summary.max_bonus }}</div>
        <div class="kpi-sub">
          {{ (summary.unique_operators?.tvattplats || 0) + (summary.unique_operators?.kontroll || 0) + (summary.unique_operators?.truck || 0) }} operatörer
        </div>
      </div>
    </div>
  </div>

  <!-- Operatörssökning -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title"><i class="fas fa-search me-2"></i>Sök operatör</h5>
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Ange operatör-ID..."
               [(ngModel)]="searchOperatorId" (keyup.enter)="searchOperator()">
        <button class="btn btn-info" (click)="searchOperator()" [disabled]="!searchOperatorId.trim()">
          <i class="fas fa-search"></i> Sök
        </button>
        <button class="btn btn-outline-secondary" *ngIf="operatorData" (click)="clearOperatorSearch()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Operatörsresultat -->
  <div *ngIf="operatorData" class="mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="fas fa-user me-2"></i>Operatör {{ operatorData.operator_id }}
          <span class="badge bg-info ms-2">{{ operatorData.position }}</span>
        </h5>
        <small class="text-muted">{{ operatorData.date_range?.from }} - {{ operatorData.date_range?.to }}</small>
      </div>
      <div class="card-body">
        <!-- Sammanfattning -->
        <div class="row g-3 mb-4">
          <div class="col-md-2 col-4">
            <div class="mini-stat">
              <div class="mini-stat-label">Cykler</div>
              <div class="mini-stat-value">{{ operatorData.summary?.total_cycles }}</div>
            </div>
          </div>
          <div class="col-md-2 col-4">
            <div class="mini-stat">
              <div class="mini-stat-label">IBC OK</div>
              <div class="mini-stat-value text-success">{{ operatorData.summary?.total_ibc_ok }}</div>
            </div>
          </div>
          <div class="col-md-2 col-4">
            <div class="mini-stat">
              <div class="mini-stat-label">Timmar</div>
              <div class="mini-stat-value">{{ operatorData.summary?.total_hours }}h</div>
            </div>
          </div>
          <div class="col-md-2 col-4">
            <div class="mini-stat">
              <div class="mini-stat-label">Snittbonus</div>
              <div class="mini-stat-value" [ngClass]="getBonusClass(operatorData.kpis?.bonus_avg)">
                {{ operatorData.kpis?.bonus_avg }}
              </div>
            </div>
          </div>
          <div class="col-md-2 col-4">
            <div class="mini-stat">
              <div class="mini-stat-label">Max</div>
              <div class="mini-stat-value" [ngClass]="getBonusClass(operatorData.kpis?.bonus_max)">
                {{ operatorData.kpis?.bonus_max }}
              </div>
            </div>
          </div>
          <div class="col-md-2 col-4">
            <div class="mini-stat">
              <div class="mini-stat-label">Min</div>
              <div class="mini-stat-value" [ngClass]="getBonusClass(operatorData.kpis?.bonus_min)">
                {{ operatorData.kpis?.bonus_min }}
              </div>
            </div>
          </div>
        </div>

        <!-- KPI:er -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="kpi-bar">
              <div class="d-flex justify-content-between mb-1">
                <span>Effektivitet</span>
                <span>{{ operatorData.kpis?.effektivitet }}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-info" [style.width.%]="operatorData.kpis?.effektivitet"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="kpi-bar">
              <div class="d-flex justify-content-between mb-1">
                <span>Produktivitet</span>
                <span>{{ operatorData.kpis?.produktivitet }} IBC/h</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-primary" [style.width.%]="operatorData.kpis?.produktivitet > 100 ? 100 : operatorData.kpis?.produktivitet"></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="kpi-bar">
              <div class="d-flex justify-content-between mb-1">
                <span>Kvalitet</span>
                <span>{{ operatorData.kpis?.kvalitet }}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar bg-success" [style.width.%]="operatorData.kpis?.kvalitet"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-3">
          <div class="col-md-5">
            <div class="chart-container">
              <h6 class="text-center mb-2">KPI Radar</h6>
              <canvas id="kpiRadarChart"></canvas>
            </div>
          </div>
          <div class="col-md-7">
            <div class="chart-container">
              <h6 class="text-center mb-2">KPI Trend</h6>
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Daglig breakdown -->
        <div class="mt-4" *ngIf="operatorData.daily_breakdown?.length">
          <h6><i class="fas fa-calendar-alt me-2"></i>Daglig breakdown</h6>
          <div class="table-responsive">
            <table class="table table-dark table-sm table-hover">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Cykler</th>
                  <th>IBC OK</th>
                  <th>IBC Ej OK</th>
                  <th>Effektivitet</th>
                  <th>Produktivitet</th>
                  <th>Kvalitet</th>
                  <th>Bonus</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let day of operatorData.daily_breakdown">
                  <td>{{ day.date }}</td>
                  <td>{{ day.cycles }}</td>
                  <td>{{ day.ibc_ok }}</td>
                  <td>{{ day.ibc_ej_ok }}</td>
                  <td>{{ day.effektivitet }}%</td>
                  <td>{{ day.produktivitet }}</td>
                  <td>{{ day.kvalitet }}%</td>
                  <td [ngClass]="getBonusClass(day.bonus_poang)">
                    <strong>{{ day.bonus_poang }}</strong>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ranking -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-medal me-2"></i>Top 10 Ranking</h5>
    </div>
    <div class="card-body">
      <!-- Tabs -->
      <ul class="nav nav-pills mb-3">
        <li class="nav-item">
          <a class="nav-link" [class.active]="activeRankingTab === 'overall'" (click)="setRankingTab('overall')">Alla</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="activeRankingTab === 'Tvättplats'" (click)="setRankingTab('Tvättplats')">Tvättplats</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="activeRankingTab === 'Kontrollstation'" (click)="setRankingTab('Kontrollstation')">Kontrollstation</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="activeRankingTab === 'Truckförare'" (click)="setRankingTab('Truckförare')">Truckförare</a>
        </li>
      </ul>

      <div class="table-responsive">
        <table class="table table-dark table-sm table-hover" *ngIf="getActiveRanking().length > 0">
          <thead>
            <tr>
              <th>#</th>
              <th>Operatör</th>
              <th *ngIf="activeRankingTab === 'overall'">Position</th>
              <th>Cykler</th>
              <th>IBC OK</th>
              <th>Timmar</th>
              <th>Effektivitet</th>
              <th>Produktivitet</th>
              <th>Kvalitet</th>
              <th>Bonus</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let op of getActiveRanking()" [class.top-three]="op.rank <= 3">
              <td><span [ngClass]="getRankBadge(op.rank)">{{ op.rank }}</span></td>
              <td>
                <a class="operator-link" (click)="searchOperatorId = '' + op.operator_id; searchOperator()">
                  {{ op.operator_id }}
                </a>
              </td>
              <td *ngIf="activeRankingTab === 'overall'">{{ op.position || '-' }}</td>
              <td>{{ op.cycles || op.total_cycles }}</td>
              <td>{{ op.total_ibc_ok }}</td>
              <td>{{ op.total_hours }}h</td>
              <td>{{ op.effektivitet }}%</td>
              <td>{{ op.produktivitet }}</td>
              <td>{{ op.kvalitet }}%</td>
              <td [ngClass]="getBonusClass(op.bonus_avg)">
                <strong>{{ op.bonus_avg }}</strong>
              </td>
            </tr>
          </tbody>
        </table>
        <p class="text-muted text-center" *ngIf="getActiveRanking().length === 0 && !loading">
          Ingen rankingdata tillgänglig för vald period.
        </p>
      </div>
    </div>
  </div>

  <!-- Skiftöversikt -->
  <div class="card mb-4" *ngIf="showTeamView">
    <div class="card-header">
      <h5 class="mb-0"><i class="fas fa-users me-2"></i>Skiftöversikt</h5>
    </div>
    <div class="card-body">
      <!-- Aggregate -->
      <div class="row g-3 mb-3" *ngIf="teamAggregate">
        <div class="col-md-2 col-4">
          <div class="mini-stat">
            <div class="mini-stat-label">Skift</div>
            <div class="mini-stat-value">{{ teamAggregate.total_shifts }}</div>
          </div>
        </div>
        <div class="col-md-2 col-4">
          <div class="mini-stat">
            <div class="mini-stat-label">Cykler</div>
            <div class="mini-stat-value">{{ teamAggregate.total_cycles }}</div>
          </div>
        </div>
        <div class="col-md-2 col-4">
          <div class="mini-stat">
            <div class="mini-stat-label">IBC OK</div>
            <div class="mini-stat-value text-success">{{ teamAggregate.total_ibc_ok }}</div>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="mini-stat">
            <div class="mini-stat-label">Snittbonus</div>
            <div class="mini-stat-value" [ngClass]="getBonusClass(teamAggregate.avg_bonus)">{{ teamAggregate.avg_bonus }}</div>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="mini-stat">
            <div class="mini-stat-label">Operatörer</div>
            <div class="mini-stat-value">{{ teamAggregate.unique_operators }}</div>
          </div>
        </div>
      </div>

      <!-- Shift table -->
      <div class="table-responsive">
        <table class="table table-dark table-sm table-hover">
          <thead>
            <tr>
              <th>Skift #</th>
              <th>Datum</th>
              <th>Operatörer</th>
              <th>Cykler</th>
              <th>IBC OK</th>
              <th>Timmar</th>
              <th>Eff.</th>
              <th>Prod.</th>
              <th>Kval.</th>
              <th>Bonus</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let shift of shifts">
              <td>{{ shift.shift_number }}</td>
              <td>{{ shift.shift_start }}</td>
              <td>{{ shift.operator_count }} st</td>
              <td>{{ shift.cycles }}</td>
              <td>{{ shift.total_ibc_ok }}</td>
              <td>{{ shift.total_hours }}h</td>
              <td>{{ shift.kpis.effektivitet }}%</td>
              <td>{{ shift.kpis.produktivitet }}</td>
              <td>{{ shift.kpis.kvalitet }}%</td>
              <td [ngClass]="getBonusClass(shift.kpis.bonus_avg)">
                <strong>{{ shift.kpis.bonus_avg }}</strong>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Formelinfo -->
  <div class="card">
    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#formulaInfo" role="button">
      <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Hur beräknas bonus?</h6>
    </div>
    <div class="collapse" id="formulaInfo">
      <div class="card-body">
        <p><strong>Tre KPI:er mäts per cykel:</strong></p>
        <ul>
          <li><strong>Effektivitet</strong> = Andel godkända IBC av total produktion</li>
          <li><strong>Produktivitet</strong> = IBC per timme, normaliserat mot produktmål</li>
          <li><strong>Kvalitet</strong> = Andel utan burfel</li>
        </ul>
        <p><strong>Viktning per produkt:</strong></p>
        <ul>
          <li>FoodGrade: 30% eff / 30% prod / 40% kvalitet</li>
          <li>NonUN: 35% eff / 45% prod / 20% kvalitet</li>
          <li>Tvättade: 40% eff / 35% prod / 25% kvalitet</li>
        </ul>
        <p><strong>Tier-multiplikatorer:</strong></p>
        <ul>
          <li>95+ poäng: x2.0 (Outstanding)</li>
          <li>90-94: x1.5 (Excellent)</li>
          <li>80-89: x1.25 (God prestanda)</li>
          <li>70-79: x1.0 (Basbonus)</li>
          <li>&lt;70: x0.75 (Under förväntan)</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<!-- Not admin -->
<div *ngIf="loggedIn && !isAdmin" class="text-center py-5">
  <i class="fas fa-lock fa-3x text-muted mb-3"></i>
  <h4>Åtkomst nekad</h4>
  <p class="text-muted">Du behöver admin-behörighet för att se bonusdashboarden.</p>
</div>

<div *ngIf="!loggedIn" class="text-center py-5">
  <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
  <h4>Logga in</h4>
  <p class="text-muted">Du behöver vara inloggad för att se denna sida.</p>
</div>
